/**
 * Created by Administrator on 2017/5/16.
 */
$(function () {
    layui.use(['layer', 'form', 'element', 'laydate'], function () {
        var layer = layui.layer
            , laydate = layui.laydate
            , form = layui.form
            , element = layui.element;

        //全局日期选择器 使用方法：class="layui-date"
        lay('.layui-date').each(function () {
            laydate.render({
                elem: this
                , trigger: 'click'
            });
        });
        lay('.layui-date-time').each(function () {
            laydate.render({
                elem: this
                , trigger: 'click'
                , type: 'datetime'
            });
        });
        layer.photos({
            photos: '#see-all'
            , anim: 5 //0-6的选择，指定弹出图片动画类型，默认随机（请注意，3.0之前的版本用shift参数）
        });
    });

    //右侧菜单增加选中样式
    var _menuUl = $("#mainnav-menu-wrap .collapse");
    var _menuLi = $("#mainnav-menu-wrap .collapse").find("li");
    _menuLi.each(function (e) {
        var _classLi = $(this).attr("class")
        if (_classLi == 'active-link') {
            $(this).parent("ul").addClass("in");
            $(this).parent("ul").parent('li').addClass("active-sub active");
        }
    })

    /*后台弹框*/
    var data = $.cookie('nifty'),
        type = 'primary',
        title = '',
        time = 3000;
    if (data == '' || data == undefined || data == null) {
        return false;
    }
    data = JSON.parse(data);
    time = data.wait * 1000;
    time = time == 0 ? 3000 : time;
    if (data.code == 0) {
        type = 'danger'
    } else if (data.code == 1) {
        var mess = ['success', 'primary', 'info', 'warning', 'mint', 'purple', 'pink', 'dark'];
        var index = Math.floor((Math.random() * mess.length));
        type = mess[index];
    }
    $.niftyNoty({
        type: type,
        title: title,
        message: data.msg,
        container: 'floating',
        timer: time,
        onShown: function () {
            $.cookie('nifty', '', {path: '/'}); //提示成功后清除cookie
        }
    });
    /*后台弹框*/
})

/**
 * 验证码更新
 * @param $this
 * @param type
 */

function refreshCapt($this, type) {
    $this = type == true ? $($this) : $($this).find("img");
    var time = Date.parse(new Date());
    $this.attr('src', '/captcha?id=' + time);
}

/**
 * 地区选择，调用方式：<span class="input-group-addon"><a href="JavaScript:void(0)" class="fa fa-pencil-square-o" onclick="getProvince(this,false)"></a></span>
 * 已固定为后台模板编辑选择
 * @param _this
 * @param status
 */
function getProvince(_this, status) {
    var str = '<select class="selectpicker" name="province" onchange="getCity(this.value,this,false)" id="province"></select>';
    if (!status) {
        $(_this).parent('span').before(str);
        $(_this).attr("onclick", "getProvince(this,true)");
        var url = "/admin/common/getarea.html";
        $.post(url, {pid: 0}, function (data) {
            $("#province").html(data);
            $(".selectpicker").selectpicker('render');
            $("#province").selectpicker('refresh');
        })
        $(_this).attr('class', "fa fa-share-square-o");
    } else {
        var index = layer.msg("确定要取消地区选择吗？", {
            time: 0, btn: ['确定', '取消'], yes: function () {
                $(_this).parent('span').siblings('div').remove();
                $(_this).attr("onclick", "getProvince(this,false)");
                $(_this).attr('class', "fa fa-pencil-square-o");
                $(_this).parent('span').siblings('input').val('');
                layer.close(index);

            }
        })
    }
}

/**
 * 城市选择，调用方式同上
 * @param id
 * @param _this
 * @param status
 */
function getCity(id, _this, status) {
    var str = '<select class="selectpicker" name="city" onchange="getArea(this.value,this,false)" id="city"></select>';
    if (!status) {
        $(_this).parent('div').after(str);
        $("#province").attr("onchange", "getCity(this.value,this,true)");
    }
    var _text = $(_this).find('option:selected').text();//获取选中的省名
    var _input = $(_this).parent('div').siblings('input');
    _input.val(_text);//给input赋值
    var url = "/admin/common/getarea.html";
    $.post(url, {pid: id}, function (data) {
        $("#city").html(data);
        $(".selectpicker").selectpicker('render');
        $("#city").selectpicker('refresh');
    })
}

/**
 * 区域选择，调用方式同上
 * @param id
 * @param _this
 * @param status
 */
function getArea(id, _this, status) {
    var str = '<select class="selectpicker" name="area" onchange="getAreaText(this.value,this)" id="area"></select>';
    if (!status) {
        $(_this).parent('div').after(str);
        $("#city").attr("onchange", "getArea(this.value,this,true)");
    }
    var _Protext = $("#province").find('option:selected').text();//获取选中的省名
    var _text = $(_this).find('option:selected').text();//获取选中的城市名
    var _input = $(_this).parent('div').siblings('input');
    _input.val('');//清空
    _input.val(_Protext + ' - ' + _text);//给input赋值
    var url = "/admin/common/getarea.html";
    $.post(url, {pid: id}, function (data) {
        $("#area").html(data);
        $(".selectpicker").selectpicker('render');
        $("#area").selectpicker('refresh');
    })
}

function getAreaText(id, _this) {
    var _Protext = $("#province").find('option:selected').text();//获取选中的省名
    var _Citytext = $("#city").find('option:selected').text();//获取选中的城市名
    var _text = $(_this).find('option:selected').text();//获取选中的当前名
    var _input = $(_this).parent('div').siblings('input');
    _input.val('');
    _input.val(_Protext + ' - ' + _Citytext + ' - ' + _text);//给input赋值
}


/**
 * base64位图片保存接口
 * @param src base64位编码
 */
function uploadBase(src) {
    $.ajax({
        url: "/admin/user/userFace",
        data: {src: src},
        type: "POST",
        dataType: 'json',
        success: function (data) {
            layer.msg(data.msg);
            if (data.status == 'SUCCESS') {
                $("input[name='photo']").val(data.src);
            }
        }
    });
}

/**
 * 后台退出
 */
function loginOut() {
    bootbox.dialog({
        message: "确定要退出吗？",
        title: "登出后台",
        buttons: {
            cancel: {
                label: "取消",
                className: "btn-default",
                callback: function () {
                }
            },
            success: {
                label: "退出",
                className: "btn-info",
                callback: function () {
                    window.location.href = '/index/loginOut';
                }
            }
        }
    });
}

/**
 * 全选、全不选、反选
 * @param type
 */
function checkThis($this, type) {
    if (type == 1 || type == '') {
        $(".form-horizontal :checkbox").prop("checked", true);
    } else if (type == 2) {
        $(".form-horizontal :checkbox").prop("checked", false);
    } else if (type == 3) {
        if ($($this).text() == '取消全选') {
            $($this).text("全选")
        } else {
            $($this).text("取消全选")
        }
        $(".form-horizontal :checkbox").each(function () {
            $(this).prop("checked", !$(this).prop("checked"));
        });
        allchk();
    }
}

function allchk() {
    var chknum = $(".form-horizontal :checkbox").size();//选项总个数
    var chk = 0;
    $(".form-horizontal :checkbox").each(function () {
        if ($(this).prop("checked") == true) {
            chk++;
        }
    });
}

/**
 * 列表的批量删除
 * @param url
 * @param DOM
 * @param className
 */
function delChecked(url, DOM, className) {
    className = !className ? 'form-horizontal' : className;
    if (!url) {
        $.niftyNoty({type: 'info', message: "亲，删除的回调地址你没有配置啊！"});
        return false;
    }
    var id = '';
    var count = 0;
    $("." + className + " :checkbox").each(function () {
        if ($(this).prop("checked")) {
            id += $(this).val() + ",";
            count++;
        }
    });
    id = id.substring(0, id.length - 1);
    if (!id) {
        $.niftyNoty({type: 'info', message: "亲，看不到你有任何的操作哦！"});
        return false;
    }
    var index = layer.confirm('确定要删除这' + count + '条记录吗？', {icon: 3, title: '提示'}, function (index) {
        //do something
        $.ajax({
            url: url,
            dataType: "json",
            data: {id: id},
            type: "post",
            success: function (data) {
                if (data.code == 1) {
                    $.niftyNoty({
                        type: 'success', message: data.msg, timer: 3000, onHidden: function () {
                            window.location.reload();
                        }
                    });
                    return false;
                }
                $.niftyNoty({message: data.msg});
                return false;
            },
            error: function () {
                $.niftyNoty({type: 'dark', message: "服务器出错了！请稍后再试~"});
                return false;
            }
        })
        layer.close(index);
    });
}

/**
 * 列表单条记录删除
 * @param url
 * @param $this
 * @returns {boolean}
 */
function delThis(url, $this) {
    if (!url) {
        layer.msg("什么也没有删除！");
        return false;
    }
    bootbox.dialog({
        message: "确定要删除此条记录吗？",
        title: "数据删除",
        buttons: {
            success: {
                label: "确认",
                className: "btn-danger",
                callback: function () {
                    $.get(url, function (data) {
                        if (data.code == 1) {
                            $($this).parents("tr").remove();
                            $.niftyNoty({type: 'success', message: data.msg});
                            return false;
                        } else {
                            $.niftyNoty({type: 'danger', message: data.msg});
                            return false;
                        }
                    })
                }
            },
            cancel: {
                label: "取消",
                className: "btn-default",
                callback: function () {
                }
            }
        }
    });
}

/**
 * AJAX获取TAGS
 * @param before name的值
 * @param after name的值
 */
function getTags(before, after) {
    var title = $('input[name=' + before + ']').val();
    $.post("/admin/ajax/getTags", {title: title}, function (data) {
        console.log(data);
        $('input[name=' + after + ']').val(data);
    })
}

/**
 * 编辑器实例化
 */
function textEditor(element) {
    if (!element) {
        element = 'content'
    }
    var editor = $("." + element).summernote({
        height: '230px', lang: "zh-CN"
    });
    return editor;
}

/**
 * 全局实例化
 * @param elem
 * @private
 */
function Myinit(elem) {
    $(".Validform").Validform({tiptype: 3});
}

/**
 * 文件上传打开窗口
 * 使用方法：input 添加 class="data-upload"
 * 返回单个或多个图片路径，以逗号隔开
 */
function upload() {
    var index = layer.open({
        id: 100,
        btn: ['确定'],
        maxmin: true,
        title: "文件上传",
        type: 2,
        shade: 0.8,
        area: ['700px', '500px'],
        content: "/admin/upload/index",
        yes: function () {
            var name = layer.getChildFrame("#data-upload", index).val(); //获取打开窗口的元素
            name = name.substring(0, name.length - 1);
            $(".data-upload").val(name);
            layer.close(index);
        }
    })
}

function viewPhoto($this, $dom) {
    console.log($($dom).val())
    var index = layer.open({
        id: 100,
        btn: ['关闭'],
        maxmin: true,
        title: "图片预览",
        type: 1,
        shade: 0.8,
        area: ['700px', '500px'],
        content: "<img src='" + $($dom).val() + "' />",
        yes: function () {
            layer.close(index);
        }
    })
}

/**
 * 新版裁剪图片
 */
function cropper() {
    var index = layer.open({
        id: 100,
        maxmin: true,
        title: "文件上传",
        type: 2,
        shade: 0.8,
        area: ['1200px', '630px'],
        content: "/admin/cropper/index"
    })
}

/**
 * 新版裁剪工具保存
 * @param $this
 * @returns {boolean}
 */
function uploadBase($this) {
    var url = $($this).attr("href");
    if (!url) {
        layer.msg("截取错误，请稍后重试！", {icon: 2});
        return false;
    }
    $.post("/admin/cropper/upload", {data: url}, function (data) {
        if (data.code == 1) {
            $(".data-cropper", window.parent.document).val(data.data);
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        } else {
            layer.msg(data.msg);
            return false;
        }
    })
    return false;
}

/**
 * 自定义弹出层
 * @param url 地址
 * @param title 标题
 * @param width 宽
 * @param height 高
 */
function openPage(url, title, width, height) {
    title = !title ? 'TE.CMS' : title;
    height = !height ? '80%' : height;
    width = !width ? '70%' : width;
    layer.open({
        title: title,
        type: 2,
        area: [width, height],
        content: url
    })
}

/**
 * 权限列表生成
 * @param url
 */
function ruleAuto(url) {
    bootbox.dialog({
        message: "此操作会清空数据，确定要重新生成权限吗？",
        title: "生成权限",
        buttons: {
            success: {
                label: "确认",
                className: "btn-danger",
                callback: function () {
                    location.href = url;
                }
            },
            cancel: {
                label: "取消",
                className: "btn-default",
                callback: function () {
                }
            }
        }
    });
}

/**
 * 列表快捷更新
 * @param url
 * @param $value
 * @returns {boolean}
 */
function send(url, $value) {
    if (!url) {
        $.niftyNoty({message: "请配置您的更新地址~", type: "danger"});
        return false;
    }
    $.post(url, $value, function (data) {
        if (data.code == 1) {
            $.niftyNoty({message: data.msg});
        } else {
            $.niftyNoty({message: data.msg, type: "danger"});
        }
        return false;
    })
}

function submit_check(formId, type, callback) {
    var user_name = document.form.user_name.value;
    if (user_name == '') {
        layer.msg('账号不能为空');
        document.form.user_name.focus();
        return false;
    }
    var password = document.form.password.value;
    if (password == '') {
        layer.msg('密码不能为空');
        document.form.password.focus();
        return false;
    }
    if (password != '') {
        var m = 0;
        $.ajax({
            url: 'ajaxCheckPass',
            type: 'post',
            data: {user_name: document.form.user_name.value, password: document.form.password.value},
            dataType: 'json',
            async: false,
            success: function (returnData) {
                if (returnData.code != 0) {
                    m = 1;
                }
            }
        });
        if (m) {
            layer.msg('手机号或者密码错误');
            document.form.user_name.focus();
            return false;
        }
    }
    var formObj = $("#" + formId);
    if (formObj.length == 0) {
        return true;
    }
    var formUrl = formObj.attr("action");
    if (formUrl == "") {
        return true;
    }
    $.ajax({
        url: formUrl,
        type: "post",
        data: formObj.serialize(),
        dataType: "json",
        success: function (returnData) {
            if (returnData.code != 0) {
                var fieldObj = '';
                if ($("input[name='" + returnData.field + "']").length > 0) {
                    fieldObj = $("input[name='" + returnData.field + "']");
                } else if ($("select[name='" + returnData.field + "']").length > 0) {
                    fieldObj = $("select[name='" + returnData.field + "']");
                }
                else if ($("textarea[name='" + returnData.field + "']").length > 0) {
                    fieldObj = $("textarea[name='" + returnData.field + "']");
                }
                layer.msg(returnData.msg);
                if (fieldObj) {
                    fieldObj.focus();
                }
            } else {
                if (type == 1) {
                    window.location.href = returnData.url;
                } else {
                    if (callback) {
                        callback();
                    }
                    formObj.submit();
                }
            }
        }
    });
}
function submit_prev(formId, type, callback) {
    // var user_name = document.form.user_name.value;
    // if (user_name == '') {
    //     layer.msg('账号不能为空');
    //     document.form.user_name.focus();
    //     return false;
    // }
    // var password = document.form.password.value;
    // if (password == '') {
    //     layer.msg('密码不能为空');
    //     document.form.password.focus();
    //     return false;
    // }
    // if (password != '') {
    //     var m = 0;
    //     $.ajax({
    //         url: 'ajaxCheckPass',
    //         type: 'post',
    //         data: {user_name: document.form.user_name.value, password: document.form.password.value},
    //         dataType: 'json',
    //         async: false,
    //         success: function (returnData) {
    //             if (returnData.code != 0) {
    //                 m = 1;
    //             }
    //         }
    //     });
    //     if (m) {
    //         layer.msg('手机号或者密码错误');
    //         document.form.user_name.focus();
    //         return false;
    //     }
    // }
    var formObj = $("#" + formId);
    if (formObj.length == 0) {
        return true;
    }
    var formUrl = formObj.attr("action");
    if (formUrl == "") {
        return true;
    }
    $.ajax({
        url: formUrl,
        type: "post",
        data: formObj.serialize(),
        dataType: "json",
        success: function (returnData) {
            if (returnData.code != 0) {
                var fieldObj = '';
                if ($("input[name='" + returnData.field + "']").length > 0) {
                    fieldObj = $("input[name='" + returnData.field + "']");
                } else if ($("select[name='" + returnData.field + "']").length > 0) {
                    fieldObj = $("select[name='" + returnData.field + "']");
                }
                else if ($("textarea[name='" + returnData.field + "']").length > 0) {
                    fieldObj = $("textarea[name='" + returnData.field + "']");
                }
                layer.msg(returnData.msg);
                if (fieldObj) {
                    fieldObj.focus();
                }
            } else {
                if (type == 1) {
                    window.location.href = returnData.url;
                } else {
                    if (callback) {
                        callback();
                    }
                    formObj.submit();
                }
            }
        }
    });
}


function test(id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDelete',
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function delSchool(id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'delSchool',
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function delCompany(company_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'delCompany',
            type: 'post',
            data: {company_id: company_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function delDepartment(department_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'delDepartment',
            type: 'post',
            data: {department_id: department_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function del1(teacher_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDelete',
            type: 'post',
            data: {teacher_id: teacher_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}
function delcourse(course_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDelete',
            type: 'post',
            data: {course_id: course_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}
function del(id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDelete',
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function delclass(id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'delclass',
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function del1(teacher_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDelete',
            type: 'post',
            data: {teacher_id: teacher_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function del2(user_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDelete',
            type: 'post',
            data: {user_id: user_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function delbaby(baby_id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'delbaby',
            type: 'post',
            data: {baby_id: baby_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function message(id) {
    layer.confirm('<input type="text"></input>', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'setDel',
            type: 'post',
            data: {baby_id: baby_id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}

function delSchoolUser(id) {
    layer.confirm('你确定要删除吗？', {
        btn: ['确定', '取消'] //按钮
    }, function () {
        $.ajax({
            url: 'delSchoolUser',
            type: 'post',
            data: {id: id},
            dataType: 'json',
            success: function (returnData) {
                if (returnData.code == 0) {
                    window.location.reload();
                } else {
                    layer.msg(returnData.msg);
                }
            }
        });
        return;
    });
}